#!/usr/bin/env bash
# agent-discord - Discord integration

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-discord - Discord messaging

Commands:
  send <channel-id> <message>  Send message to channel
  webhook <message>            Send via webhook URL
  snapshot                   Discord state as JSON (guilds, channels)
  guilds                     List servers the bot is in
  channels <guild-id>        List channels in a server

Environment:
  DISCORD_TOKEN                Bot token
  DISCORD_WEBHOOK_URL          Webhook URL

Examples:
  agent-discord send 123456789 "Hello from agent-do!"
  agent-discord webhook "Build completed"
EOF
}

send_api() {
    local channel_id="$1"
    local message="$2"
    local token="${DISCORD_TOKEN:-}"

    if [[ -z "$token" ]]; then
        echo "Error: DISCORD_TOKEN not set"
        return 1
    fi

    curl -s -X POST "https://discord.com/api/v10/channels/${channel_id}/messages" \
        -H "Authorization: Bot $token" \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"$message\"}" | \
        python3 -c "import sys,json; r=json.load(sys.stdin); print('Sent!' if 'id' in r else f'Error: {r}')"
}

send_webhook() {
    local message="$1"
    local webhook="${DISCORD_WEBHOOK_URL:-}"

    if [[ -z "$webhook" ]]; then
        echo "Error: DISCORD_WEBHOOK_URL not set"
        return 1
    fi

    local response
    response=$(curl -s -X POST "$webhook" \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"$message\"}")

    if [[ -z "$response" ]]; then
        echo "Sent!"
    else
        echo "Response: $response"
    fi
}

cmd_send() {
    local channel_id="${1:-}"
    shift || true
    local message="$*"

    if [[ -z "$channel_id" ]] || [[ -z "$message" ]]; then
        echo "Error: Channel ID and message required"
        return 1
    fi

    send_api "$channel_id" "$message"
}

cmd_webhook() {
    local message="$*"

    if [[ -z "$message" ]]; then
        echo "Error: Message required"
        return 1
    fi

    send_webhook "$message"
}

cmd_snapshot() {
    local token="${DISCORD_TOKEN:-}"
    if [[ -z "$token" ]]; then
        echo '{"error": "DISCORD_TOKEN not set"}'
        return 1
    fi

    python3 -c "
import urllib.request, json, os

token = os.environ.get('DISCORD_TOKEN', '')
headers = {'Authorization': f'Bot {token}'}

def discord_get(endpoint):
    url = f'https://discord.com/api/v10{endpoint}'
    req = urllib.request.Request(url, headers=headers)
    try:
        with urllib.request.urlopen(req) as resp:
            return json.loads(resp.read())
    except Exception as e:
        return {'error': str(e)}

# Get bot user
user = discord_get('/users/@me')

# Get guilds
guilds_data = discord_get('/users/@me/guilds')
guilds = []
if isinstance(guilds_data, list):
    for g in guilds_data[:20]:
        guilds.append({'id': g['id'], 'name': g['name'], 'owner': g.get('owner', False)})

snapshot = {
    'bot': {'name': user.get('username', '?'), 'id': user.get('id', '?')} if isinstance(user, dict) and 'id' in user else {'error': str(user)},
    'guilds': {'count': len(guilds), 'items': guilds},
    'token_valid': isinstance(user, dict) and 'id' in user,
    'webhook_configured': bool(os.environ.get('DISCORD_WEBHOOK_URL')),
}
print(json.dumps(snapshot, indent=2))
"
}

cmd_guilds() {
    local token="${DISCORD_TOKEN:-}"
    [[ -z "$token" ]] && { echo "Error: DISCORD_TOKEN not set"; return 1; }
    curl -s "https://discord.com/api/v10/users/@me/guilds" \
        -H "Authorization: Bot $token" | \
        python3 -c "import sys,json; [print(f'{g[\"name\"]} ({g[\"id\"]})') for g in json.load(sys.stdin)]"
}

cmd_channels() {
    local guild_id="${1:-}"
    local token="${DISCORD_TOKEN:-}"
    [[ -z "$token" ]] && { echo "Error: DISCORD_TOKEN not set"; return 1; }
    [[ -z "$guild_id" ]] && { echo "Usage: agent-discord channels <guild-id>"; return 1; }
    curl -s "https://discord.com/api/v10/guilds/${guild_id}/channels" \
        -H "Authorization: Bot $token" | \
        python3 -c "
import sys, json
channels = json.load(sys.stdin)
if isinstance(channels, list):
    for ch in sorted(channels, key=lambda c: c.get('position', 0)):
        prefix = '#' if ch.get('type', 0) == 0 else 'üîä' if ch.get('type', 0) == 2 else 'üìÅ'
        print(f'{prefix} {ch[\"name\"]} ({ch[\"id\"]})')
else:
    print(f'Error: {channels}')
"
}

# Main
case "${1:-help}" in
    snapshot|snap)
        cmd_snapshot
        ;;
    guilds|servers)
        cmd_guilds
        ;;
    channels|ch)
        shift
        cmd_channels "$@"
        ;;
    send|message)
        shift
        cmd_send "$@"
        ;;
    webhook|hook)
        shift
        cmd_webhook "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-discord help"
        exit 1
        ;;
esac
