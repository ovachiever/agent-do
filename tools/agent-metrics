#!/usr/bin/env bash
# agent-metrics - System metrics and monitoring

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-metrics - System metrics and monitoring

Commands:
  cpu                        CPU usage
  memory                     Memory usage
  disk                       Disk usage
  network                    Network stats
  processes [n]              Top processes (default: 10)
  load                       System load average
  uptime                     System uptime
  all                        Summary of all metrics

Options:
  --watch                    Continuous monitoring
  --interval <sec>           Watch interval (default: 2)
  --json                     Output as JSON

Examples:
  agent-metrics cpu
  agent-metrics memory
  agent-metrics processes 20
  agent-metrics all
  agent-metrics cpu --watch
EOF
}

cmd_cpu() {
    local watch=""
    local interval=2
    local json=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --watch|-w) watch=1; shift ;;
            --interval|-i) interval="$2"; shift 2 ;;
            --json) json=1; shift ;;
            *) shift ;;
        esac
    done

    if [[ "$(uname)" == "Darwin" ]]; then
        if [[ -n "$watch" ]]; then
            while true; do
                top -l 1 -n 0 | grep "CPU usage"
                sleep "$interval"
            done
        else
            top -l 1 -n 0 | grep "CPU usage"
        fi
    else
        if [[ -n "$watch" ]]; then
            while true; do
                grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {printf "CPU: %.1f%%\n", usage}'
                sleep "$interval"
            done
        else
            grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {printf "CPU: %.1f%%\n", usage}'
        fi
    fi
}

cmd_memory() {
    local json=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --json) json=1; shift ;;
            *) shift ;;
        esac
    done

    if [[ "$(uname)" == "Darwin" ]]; then
        vm_stat | perl -ne '/page size of (\d+)/ and $size=$1; /Pages\s+([^:]+)[^\d]+(\d+)/ and printf("%-16s %6.1f MB\n", "$1:", $2 * $size / 1048576);'
    else
        free -h
    fi
}

cmd_disk() {
    df -h | grep -E "^/dev|Filesystem"
}

cmd_network() {
    if [[ "$(uname)" == "Darwin" ]]; then
        netstat -ib | head -10
    else
        if command -v ip &> /dev/null; then
            ip -s link | head -30
        else
            netstat -i
        fi
    fi
}

cmd_processes() {
    local count="${1:-10}"

    if [[ "$(uname)" == "Darwin" ]]; then
        ps aux | head -1
        ps aux --sort=-%cpu | head -n "$((count + 1))" | tail -n "$count"
    else
        ps aux --sort=-%cpu | head -n "$((count + 1))"
    fi
}

cmd_load() {
    if [[ "$(uname)" == "Darwin" ]]; then
        sysctl -n vm.loadavg
    else
        cat /proc/loadavg
    fi
}

cmd_uptime() {
    uptime
}

cmd_all() {
    echo "=== System Metrics ==="
    echo

    echo "--- Uptime ---"
    uptime
    echo

    echo "--- CPU ---"
    cmd_cpu 2>/dev/null || echo "Could not get CPU info"
    echo

    echo "--- Memory ---"
    if [[ "$(uname)" == "Darwin" ]]; then
        top -l 1 -n 0 | grep PhysMem
    else
        free -h | grep -E "^Mem"
    fi
    echo

    echo "--- Disk ---"
    df -h / | tail -1
    echo

    echo "--- Load ---"
    cmd_load
    echo

    echo "--- Top Processes (by CPU) ---"
    cmd_processes 5
}

cmd_watch_all() {
    local interval="${1:-2}"

    while true; do
        clear
        echo "=== System Monitor ($(date)) ==="
        echo
        cmd_all
        sleep "$interval"
    done
}

# Main
case "${1:-help}" in
    cpu)
        shift || true
        cmd_cpu "$@"
        ;;
    memory|mem|ram)
        shift || true
        cmd_memory "$@"
        ;;
    disk|storage)
        cmd_disk
        ;;
    network|net)
        cmd_network
        ;;
    processes|ps|top)
        shift || true
        cmd_processes "$@"
        ;;
    load)
        cmd_load
        ;;
    uptime)
        cmd_uptime
        ;;
    all|summary)
        cmd_all
        ;;
    watch)
        shift || true
        cmd_watch_all "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-metrics help"
        exit 1
        ;;
esac
