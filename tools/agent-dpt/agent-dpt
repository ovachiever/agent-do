#!/usr/bin/env bash
# agent-dpt - Design Perception Tensor: AI-first design quality scoring
# Part of the agent-do ecosystem
#
# "DPT does not measure taste. It measures whether the unconscious will flinch."
#
# 72 rules across 5 perception layers (chromatic field, typographic skeleton,
# spatial rhythm, attention architecture, coherence) fused into a 0-100 score.

set -euo pipefail

DPT_DIR="/Users/erik/Documents/AI/Custom_Coding/dpt"
DPT_ENGINE="$DPT_DIR/dist/dpt-engine.js"
DPT_REPORT="$DPT_DIR/bin/dpt-report"
TMPDIR_ACTUAL="$(python3 -c 'import tempfile; print(tempfile.gettempdir())')"
BASELINE_FILE="/tmp/dpt-baseline.json"
DPT_RESULT_FILE=$(mktemp "${TMPDIR_ACTUAL}/dpt-result-XXXXXX")

cleanup() { rm -f "$DPT_RESULT_FILE"; }
trap cleanup EXIT

show_help() {
    cat << 'EOF'
agent-dpt - Design Perception Tensor

Automated design quality scoring: 72 rules, 5 perception layers, 0-100 score.

COMMANDS:
  scan [url]           Full scan â†’ structured JSON
  score [url]          Quick: score + grade + dimensions + critical failures
  report [url]         Narrative design critique report
  violations [url]     Violations sorted by impact (for AI fix loops)
  baseline [url]       Save current scan as comparison baseline
  diff [url]           Compare current scan against saved baseline
  build                Rebuild engine from source
  help                 Show this help

OPTIONS:
  --current            Scan currently open page (default if no URL given)
  --quiet              Machine-readable one-line output (for hooks)
  --json               Raw JSON output (for scan command)

EXAMPLES:
  agent-dpt score                          # Score current page
  agent-dpt score https://stripe.com       # Score a URL
  agent-dpt violations                     # Get fix list for AI
  agent-dpt baseline                       # Save baseline
  agent-dpt diff                           # Check improvement
  agent-dpt scan --json > result.json      # Export full scan
EOF
}

# ============================================================================
# CORE
# ============================================================================

find_socket() {
    local sock="${TMPDIR_ACTUAL}/agent-browser-default.sock"
    [[ -S "$sock" ]] && { echo "$sock"; return 0; }
    sock=$(find "$TMPDIR_ACTUAL" -name 'agent-browser-*.sock' -type s 2>/dev/null | head -1)
    [[ -n "$sock" && -S "$sock" ]] && { echo "$sock"; return 0; }
    return 1
}

navigate_if_url() {
    local url="$1"
    if [[ -n "$url" && "$url" != "--"* ]]; then
        agent-do browse open "$url" > /dev/null 2>&1
        agent-do browse wait --stable > /dev/null 2>&1
        sleep 1
    fi
}

inject_engine() {
    local sock
    sock=$(find_socket) || { echo "No agent-browser daemon. Start: agent-do browse open <url>" >&2; return 1; }
    [[ -f "$DPT_ENGINE" ]] || { echo "Engine not found. Run: agent-dpt build" >&2; return 1; }

    python3 -c "
import json, socket, sys
with open(sys.argv[1]) as f:
    js = f.read()
msg = json.dumps({'id': 'agent-dpt', 'action': 'evaluate', 'script': js})
s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
s.settimeout(45)
s.connect(sys.argv[2])
s.sendall(msg.encode('utf-8') + b'\n')
chunks = []
while True:
    try:
        chunk = s.recv(131072)
        if not chunk: break
        chunks.append(chunk)
        try:
            json.loads(b''.join(chunks)); break
        except json.JSONDecodeError: continue
    except socket.timeout: break
s.close()
raw = b''.join(chunks).decode('utf-8', errors='replace')
resp = json.loads(raw)
if resp.get('success'):
    result = resp.get('data', {}).get('result', {})
    if isinstance(result, str): result = json.loads(result)
    with open(sys.argv[3], 'w') as out:
        json.dump(result, out)
else:
    sys.exit(1)
" "$DPT_ENGINE" "$sock" "$DPT_RESULT_FILE"
}

# ============================================================================
# COMMANDS
# ============================================================================

cmd_scan() {
    local url="" json_out=false
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --json|-j) json_out=true; shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    navigate_if_url "$url"
    inject_engine || exit 1
    if [[ "$json_out" == true ]]; then cat "$DPT_RESULT_FILE"; else python3 -m json.tool "$DPT_RESULT_FILE"; fi
}

cmd_score() {
    local url="" quiet=false
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --quiet|-q) quiet=true; shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    navigate_if_url "$url"
    inject_engine || exit 1

    local qflag="false"; [[ "$quiet" == true ]] && qflag="true"
    python3 - "$DPT_RESULT_FILE" "$qflag" << 'SCORE_PY'
import json, sys
with open(sys.argv[1]) as f:
    data = json.load(f)
syn = data.get("synthesis", {})
dims = syn.get("dimensions", {})
meta = data.get("meta", {})
score = syn.get("overall_score", "?")
grade = syn.get("overall_grade", "?")
crit = syn.get("critical_failures", [])
strengths = syn.get("top_strengths", [])
quiet = sys.argv[2] == "true"

if quiet:
    dp = [f"{k[:3]}{dims.get(k,{}).get('score','?')}" for k in ["chromatic","typography","spatial","attention","coherence"]]
    cs = f". Critical: {'; '.join(crit)}" if crit else ""
    print(f"DPT: {score} {grade} ({' '.join(dp)}){cs}")
else:
    print(f"\n  DPT: {score} {grade}  ({meta.get('element_count','?')} elements, {meta.get('total_timing_ms','?')}ms)")
    print(f"  URL: {meta.get('url', '?')}\n")
    for k in ["chromatic","typography","spatial","attention","coherence"]:
        d = dims.get(k, {})
        fl = f"  !{','.join(d.get('hard_floors_hit',[]))}" if d.get("hard_floors_hit") else ""
        print(f"    {k:12s} {d.get('score','?'):>3} {d.get('grade','?'):>3}{fl}")
    print()
    if crit: print(f"  Critical: {'; '.join(crit)}")
    if strengths: print(f"  Strengths: {', '.join(strengths)}")
    if crit or strengths: print()
SCORE_PY
}

cmd_report() {
    local url=""
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    navigate_if_url "$url"
    inject_engine || exit 1
    python3 "$DPT_REPORT" "$DPT_RESULT_FILE"
}

cmd_violations() {
    local url=""
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    navigate_if_url "$url"
    inject_engine || exit 1

    python3 - "$DPT_RESULT_FILE" << 'VIOL_PY'
import json, sys
with open(sys.argv[1]) as f:
    data = json.load(f)
syn = data.get("synthesis", {})
crit = syn.get("critical_failures", [])
violations = []
for lk, pfx in [("chromatic_field","CF"),("typographic_skeleton","TS"),("spatial_rhythm","SR"),("attention_architecture","AA"),("coherence","CO")]:
    layer = data.get(lk, {})
    if not isinstance(layer, dict): continue
    for ck, cd in layer.items():
        if not isinstance(cd, dict) or ck.startswith("_"): continue
        if cd.get("pass") is not False: continue
        v = {"check": ck, "layer": pfx}
        for key in ["violations","undersized","without_hyphens","faux_bold","faux_italic","distorted_elements","generic_links","generic_labels"]:
            if key in cd: v[key] = cd[key]
        if "total_interactive" in cd: v["total"] = cd["total_interactive"]
        violations.append(v)

print(f"\n  VIOLATIONS ({len(violations)} checks failing)\n")
if crit:
    print("  CRITICAL:")
    for c in crit: print(f"    \u2715 {c}")
    print()
for v in violations:
    print(f"  [{v['layer']}] {v['check'].replace('_',' ').upper()}")
    viols = v.get("violations", [])
    for vl in (viols[:3] if isinstance(viols, list) else []):
        if isinstance(vl, dict):
            sel = vl.get("selector","?")
            dets = [f"{dk}={vl[dk]}" for dk in ["contrast","width","height","text"] if dk in vl]
            print(f"    \u2192 {sel}" + (f" ({', '.join(dets)})" if dets else ""))
    if "undersized" in v: print(f"    \u2192 {v['undersized']}/{v.get('total','?')} below minimum")
    if "faux_bold" in v: print(f"    \u2192 {v['faux_bold']} faux bold, {v.get('faux_italic',0)} faux italic")
print()
VIOL_PY
}

cmd_baseline() {
    local url=""
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    navigate_if_url "$url"
    inject_engine || exit 1
    cp "$DPT_RESULT_FILE" "$BASELINE_FILE"
    python3 -c "import json; d=json.load(open('$BASELINE_FILE')); s=d.get('synthesis',{}); print(f\"Baseline saved: {s.get('overall_score','?')} {s.get('overall_grade','?')} \u2192 $BASELINE_FILE\")"
}

cmd_diff() {
    local url=""
    while [[ $# -gt 0 ]]; do
        case "$1" in --current|-c) shift ;; --*) shift ;; *) url="$1"; shift ;; esac
    done
    [[ -f "$BASELINE_FILE" ]] || { echo "No baseline. Run: agent-dpt baseline" >&2; exit 1; }
    navigate_if_url "$url"
    inject_engine || exit 1

    python3 - "$BASELINE_FILE" "$DPT_RESULT_FILE" << 'DIFF_PY'
import json, sys
with open(sys.argv[1]) as f: baseline = json.load(f)
with open(sys.argv[2]) as f: current = json.load(f)
bs, cs = baseline.get("synthesis",{}), current.get("synthesis",{})
bd, cd = bs.get("dimensions",{}), cs.get("dimensions",{})
b_s, c_s = bs.get("overall_score",0), cs.get("overall_score",0)
d = c_s - b_s
arr = "\u25b2" if d>0 else "\u25bc" if d<0 else "="
col = "\033[32m" if d>0 else "\033[31m" if d<0 else "\033[33m"
rst = "\033[0m"
print(f"\n  DPT DIFF: {b_s} {bs.get('overall_grade','?')} \u2192 {c_s} {cs.get('overall_grade','?')}  {col}{arr}{abs(d):+d}{rst}\n")
grn, red = "\033[32m", "\033[31m"
up, dn = "\u25b2", "\u25bc"
for k in ["chromatic","typography","spatial","attention","coherence"]:
    b = bd.get(k,{}).get("score",0); c = cd.get(k,{}).get("score",0); dd = c-b
    if dd:
        dcol = grn if dd>0 else red
        darr = up if dd>0 else dn
        print(f"    {k:12s} {b:>3} \u2192 {c:>3}  {dcol}{darr}{abs(dd)}{rst}")
    else: print(f"    {k:12s} {b:>3} \u2192 {c:>3}  =")
nc = set(cs.get("critical_failures",[])) - set(bs.get("critical_failures",[]))
rv = set(bs.get("critical_failures",[])) - set(cs.get("critical_failures",[]))
if nc: print(f"\n  \033[31mNew critical:\033[0m {'; '.join(nc)}")
if rv: print(f"  \033[32mResolved:\033[0m {'; '.join(rv)}")
print()
DIFF_PY
}

cmd_build() { bash "$DPT_DIR/bin/build"; }

# ============================================================================
# DISPATCH
# ============================================================================

main() {
    local cmd="${1:-help}"; shift 2>/dev/null || true
    case "$cmd" in
        scan|s)             cmd_scan "$@" ;;
        score|sc)           cmd_score "$@" ;;
        report|r)           cmd_report "$@" ;;
        violations|v|fix)   cmd_violations "$@" ;;
        baseline|bl)        cmd_baseline "$@" ;;
        diff|d)             cmd_diff "$@" ;;
        build|b)            cmd_build ;;
        help|--help|-h)     show_help ;;
        *)                  echo "Unknown: $cmd. Try: agent-dpt help" >&2; exit 1 ;;
    esac
}

main "$@"
