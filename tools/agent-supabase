#!/usr/bin/env bash
# agent-supabase - Supabase project and database management

set -euo pipefail

SUPABASE_API="https://api.supabase.com/v1"

show_help() {
    cat << 'EOF'
agent-supabase - Supabase project and database management

PROJECT MANAGEMENT
  projects / ls                List all projects
  show <ref>                   Project details
  pause <ref>                  Pause project
  restore <ref>                Restore paused project
  health <ref>                 Service health status
  api-keys <ref>               List API keys (anon, service_role)
  secrets <ref>                List secrets (env vars)
  secret-set <ref> <k> <v>     Create/update secret
  secret-del <ref> <name>      Delete secret
  functions <ref>              List edge functions
  function-show <ref> <slug>   Edge function details
  domains <ref>                Custom hostname info
  types <ref>                  Generate TypeScript types
  orgs                         List organizations
  regions                      List available regions
  postgrest <ref>              PostgREST config
  snapshot                     Full account state as JSON

DATA ACCESS — REST API (no DB password needed)
  rest <ref> <table>                   Query table (GET)
  rest <ref> <table> --select "a,b"    Select specific columns
  rest <ref> <table> --filter "k=eq.v" Filter rows (PostgREST syntax)
  rest <ref> <table> --limit N         Limit rows (default: 20)
  rest <ref> <table> --single          Expect single row (.single())
  rest <ref> <table> --count           Return count only
  rest <ref> <table> --update '{"k":"v"}' --filter "..."   Update matching rows (PATCH)
  rest <ref> <table> --insert '{"k":"v"}'                  Insert row(s) (POST)
  rest <ref> <table> --upsert '{"k":"v"}'                  Upsert row(s) (POST + merge)
  rest <ref> <table> --delete --filter "..."               Delete matching rows (DELETE)

DATA ACCESS — SQL via Management API (no DB password needed)
  sql <ref> "<sql>"            Run SQL via Management API
  sql <ref> --file <path>      Run SQL from a .sql file
  sql <ref> "<sql>" --read-only  Run in read-only mode (prevents writes)

DATA ACCESS — SQL via agent-db (requires DB password)
  db-connect <ref>             Auto-create agent-db profile and connect
  db-status <ref>              Check if agent-db profile exists
  query <ref> "<sql>"          Run SQL (delegates to agent-db)
  tables <ref>                 List tables (delegates to agent-db)
  describe <ref> <table>       Describe table (delegates to agent-db)
  sample <ref> <table> [n]     Sample rows (delegates to agent-db)

Projects are referenced by their ref (20-char project ID).

Environment:
  SUPABASE_ACCESS_TOKEN        API token (Bearer) — required
  SUPABASE_DB_PASSWORD         DB password for SQL access (optional)

Examples:
  # Project management
  agent-supabase projects
  agent-supabase health abcdefghijklmnopqrst

  # REST API — read (easiest — no password needed)
  agent-supabase rest <ref> users
  agent-supabase rest <ref> orders --select "id,total,status" --filter "status=eq.pending" --limit 10

  # REST API — write
  agent-supabase rest <ref> reports --update '{"published": false}' --filter "slug=eq.my-report"
  agent-supabase rest <ref> users --insert '{"name": "Alice", "email": "alice@example.com"}'
  agent-supabase rest <ref> users --upsert '{"id": 1, "name": "Alice"}'
  agent-supabase rest <ref> old_logs --delete --filter "created_at=lt.2024-01-01"

  # SQL via Management API (no password needed — uses access token)
  agent-supabase sql <ref> "SELECT count(*) FROM users"
  agent-supabase sql <ref> "CREATE TABLE foo (id serial primary key, name text)"
  agent-supabase sql <ref> --file migrations/001_create_tables.sql
  agent-supabase sql <ref> "SELECT * FROM users LIMIT 5" --read-only

  # SQL via agent-db (direct Postgres connection — full SQL power)
  agent-supabase db-connect <ref>
  agent-supabase query <ref> "SELECT count(*) FROM users"
  agent-supabase tables <ref>
  agent-supabase sample <ref> orders 5
EOF
}

# --- Resolve agent-db ---

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

find_agent_db() {
    # 1. Sibling tool in the same tools/ directory
    if [[ -x "$SCRIPT_DIR/agent-db/agent-db" ]]; then
        echo "$SCRIPT_DIR/agent-db/agent-db"
        return
    fi
    # 2. In PATH via agent-do dispatcher
    if command -v agent-do &>/dev/null; then
        echo "agent-do db"
        return
    fi
    echo ""
}

AGENT_DB_CMD="$(find_agent_db)"

run_agent_db() {
    if [[ -z "$AGENT_DB_CMD" ]]; then
        echo "Error: agent-db not found. Install agent-do or check tools/agent-db/" >&2
        return 1
    fi
    $AGENT_DB_CMD "$@"
}

# Profile name convention: supabase-<ref>
db_profile_name() {
    echo "supabase-${1}"
}

# Get service_role key for a project (cached per invocation)
_SERVICE_ROLE_CACHE=""
_SERVICE_ROLE_REF=""
get_service_role_key() {
    local ref="$1"
    if [[ "$_SERVICE_ROLE_REF" == "$ref" && -n "$_SERVICE_ROLE_CACHE" ]]; then
        echo "$_SERVICE_ROLE_CACHE"
        return
    fi
    local result
    result=$(supabase_request GET "/projects/$ref/api-keys" 2>/dev/null)
    local key
    key=$(echo "$result" | python3 -c "
import json, sys
data = json.load(sys.stdin)
for k in data:
    if k.get('name') == 'service_role':
        print(k.get('api_key', ''))
        break
" 2>/dev/null)
    _SERVICE_ROLE_CACHE="$key"
    _SERVICE_ROLE_REF="$ref"
    echo "$key"
}

# --- Helpers ---

supabase_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local token="${SUPABASE_ACCESS_TOKEN:-}"

    if [[ -z "$token" ]]; then
        echo "Error: SUPABASE_ACCESS_TOKEN not set" >&2
        return 1
    fi

    local args=(-s -X "$method" "${SUPABASE_API}${endpoint}" \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/json")

    if [[ -n "$data" ]]; then
        args+=(-d "$data")
    fi

    curl "${args[@]}"
}

json_escape() {
    python3 -c "import json,sys; print(json.dumps(sys.argv[1]))" "$1"
}

# --- Commands ---

cmd_projects() {
    local result
    result=$(supabase_request GET "/projects")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No projects found')
    sys.exit(0)
for p in data:
    ref = p.get('id', '')
    name = p.get('name', '')
    region = p.get('region', '')
    status = p.get('status', '')
    created = p.get('created_at', '')[:10] if p.get('created_at') else ''
    print(f'{ref}  {name}  [{region}]  {status}  {created}')
"
}

cmd_show() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase show <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref")

    echo "$result" | python3 -c "
import sys, json
p = json.load(sys.stdin)
if 'message' in p:
    print(f\"Error: {p['message']}\")
    sys.exit(1)
print(f\"ID:         {p.get('id', '')}\")
print(f\"Name:       {p.get('name', '')}\")
print(f\"Org ID:     {p.get('organization_id', '')}\")
print(f\"Region:     {p.get('region', '')}\")
print(f\"Status:     {p.get('status', '')}\")
print(f\"DB Version: {p.get('database', {}).get('version', '')}\")
created = p.get('created_at', '')
if created:
    print(f'Created:    {created[:19]}')
"
}

cmd_pause() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase pause <ref>"
        return 1
    fi

    local result
    result=$(supabase_request POST "/projects/$ref/pause")

    if [[ -z "$result" || "$result" == "{}" ]]; then
        echo "Paused project $ref"
    else
        echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
if 'message' in d:
    print(f\"Error: {d['message']}\")
    sys.exit(1)
print(f'Paused project: $ref')
" 2>/dev/null || echo "Paused project $ref"
    fi
}

cmd_restore() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase restore <ref>"
        return 1
    fi

    local result
    result=$(supabase_request POST "/projects/$ref/restore")

    if [[ -z "$result" || "$result" == "{}" ]]; then
        echo "Restoring project $ref"
    else
        echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
if 'message' in d:
    print(f\"Error: {d['message']}\")
    sys.exit(1)
print(f'Restoring project: $ref')
" 2>/dev/null || echo "Restoring project $ref"
    fi
}

cmd_health() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase health <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/health")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No health data')
    sys.exit(0)
for svc in data:
    name = svc.get('name', '')
    status = svc.get('status', '')
    print(f'{name}: {status}')
"
}

cmd_api_keys() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase api-keys <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/api-keys")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No API keys found')
    sys.exit(0)
for k in data:
    name = k.get('name', '')
    key = k.get('api_key', '')
    display = key[:8] + '****' if len(key) > 12 else key
    print(f'{name}: {display}')
"
}

cmd_secrets() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase secrets <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/secrets")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No secrets found')
    sys.exit(0)
for s in data:
    name = s.get('name', '')
    value = s.get('value', '')
    if value:
        display = value[:4] + '****' if len(value) > 8 else value
    else:
        display = '(empty)'
    print(f'{name}={display}')
"
}

cmd_secret_set() {
    local ref="${1:-}"
    local key="${2:-}"
    local val="${3:-}"

    if [[ -z "$ref" ]] || [[ -z "$key" ]] || [[ -z "$val" ]]; then
        echo "Usage: agent-supabase secret-set <ref> <KEY> <VALUE>"
        return 1
    fi

    local escaped_val
    escaped_val=$(json_escape "$val")

    local body="[{\"name\": \"$key\", \"value\": $escaped_val}]"

    local result
    result=$(supabase_request POST "/projects/$ref/secrets" "$body")

    if [[ -z "$result" || "$result" == "{}" ]]; then
        echo "Set secret $key on $ref"
    else
        echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
if isinstance(d, dict) and 'message' in d:
    print(f\"Error: {d['message']}\")
    sys.exit(1)
print(f'Set secret $key on $ref')
" 2>/dev/null || echo "Set secret $key on $ref"
    fi
}

cmd_secret_del() {
    local ref="${1:-}"
    local name="${2:-}"

    if [[ -z "$ref" ]] || [[ -z "$name" ]]; then
        echo "Usage: agent-supabase secret-del <ref> <SECRET_NAME>"
        return 1
    fi

    local body="[\"$name\"]"

    supabase_request DELETE "/projects/$ref/secrets" "$body" > /dev/null
    echo "Deleted secret $name from $ref"
}

cmd_functions() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase functions <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/functions")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No edge functions found')
    sys.exit(0)
for f in data:
    slug = f.get('slug', '')
    name = f.get('name', '')
    status = f.get('status', '')
    version = f.get('version', '')
    updated = f.get('updated_at', '')[:19] if f.get('updated_at') else ''
    print(f'{slug}  {name}  [{status}]  v{version}  {updated}')
"
}

cmd_function_show() {
    local ref="${1:-}"
    local slug="${2:-}"

    if [[ -z "$ref" ]] || [[ -z "$slug" ]]; then
        echo "Usage: agent-supabase function-show <ref> <slug>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/functions/$slug")

    echo "$result" | python3 -c "
import sys, json
f = json.load(sys.stdin)
if 'message' in f:
    print(f\"Error: {f['message']}\")
    sys.exit(1)
print(f\"ID:       {f.get('id', '')}\")
print(f\"Name:     {f.get('name', '')}\")
print(f\"Slug:     {f.get('slug', '')}\")
print(f\"Status:   {f.get('status', '')}\")
print(f\"Version:  {f.get('version', '')}\")
print(f\"Verify:   {f.get('verify_jwt', '')}\")
created = f.get('created_at', '')
if created:
    print(f'Created:  {created[:19]}')
updated = f.get('updated_at', '')
if updated:
    print(f'Updated:  {updated[:19]}')
"
}

cmd_domains() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase domains <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/custom-hostname")

    echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
if isinstance(d, dict) and 'message' in d:
    print(f\"Error: {d['message']}\")
    sys.exit(1)
status = d.get('status', '')
hostname = d.get('custom_hostname', '') or d.get('hostname', '')
if hostname:
    print(f'Hostname: {hostname}')
    print(f'Status:   {status}')
    data = d.get('data', {})
    if data:
        print(f'SSL:      {data.get(\"ssl\", {}).get(\"status\", \"\")}')
else:
    print('No custom hostname configured')
"
}

cmd_types() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase types <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/types/typescript")

    echo "$result" | python3 -c "
import sys, json
try:
    d = json.load(sys.stdin)
    if isinstance(d, dict) and 'message' in d:
        print(f\"Error: {d['message']}\")
        sys.exit(1)
    types = d.get('types', '')
    if types:
        print(types)
    else:
        print(json.dumps(d, indent=2))
except:
    # Response may be plain text
    pass
" 2>/dev/null || echo "$result"
}

cmd_orgs() {
    local result
    result=$(supabase_request GET "/organizations")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No organizations found')
    sys.exit(0)
for o in data:
    oid = o.get('id', '')
    name = o.get('name', '')
    print(f'{oid}  {name}')
"
}

cmd_regions() {
    local result
    result=$(supabase_request GET "/projects/available-regions")

    echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f\"Error: {data['message']}\")
    sys.exit(1)
if not data:
    print('No regions available')
    sys.exit(0)
for r in data:
    if isinstance(r, dict):
        print(f\"{r.get('region', '')}  {r.get('display_name', '')}\")
    else:
        print(r)
"
}

cmd_postgrest() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase postgrest <ref>"
        return 1
    fi

    local result
    result=$(supabase_request GET "/projects/$ref/postgrest")

    echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
if 'message' in d:
    print(f\"Error: {d['message']}\")
    sys.exit(1)
print(f\"Max Rows:       {d.get('max_rows', '')}\")
print(f\"DB Schema:      {d.get('db_schema', '')}\")
print(f\"DB Extra Search: {d.get('db_extra_search_path', '')}\")
print(f\"Pool Size:      {d.get('db_pool', '')}\")
"
}

cmd_snapshot() {
    local token="${SUPABASE_ACCESS_TOKEN:-}"
    if [[ -z "$token" ]]; then
        echo '{"error": "SUPABASE_ACCESS_TOKEN not set"}'
        return 1
    fi

    python3 -c "
import json, sys, os
from urllib.request import Request, urlopen
from urllib.error import HTTPError

API = 'https://api.supabase.com/v1'
TOKEN = os.environ.get('SUPABASE_ACCESS_TOKEN', '')

def api_get(path):
    url = API + path
    req = Request(url, headers={
        'Authorization': 'Bearer ' + TOKEN,
        'Content-Type': 'application/json',
        'User-Agent': 'agent-supabase/1.0',
    })
    try:
        with urlopen(req) as resp:
            return json.loads(resp.read())
    except HTTPError as e:
        if e.code == 401:
            return {'error': 'unauthorized'}
        return {'error': str(e)}
    except Exception as e:
        return {'error': str(e)}

# Organizations
raw_orgs = api_get('/organizations')
orgs = []
token_valid = not isinstance(raw_orgs, dict) or 'error' not in raw_orgs
if isinstance(raw_orgs, list):
    for o in raw_orgs:
        orgs.append({
            'id': o.get('id', ''),
            'name': o.get('name', ''),
        })

# Projects
raw_projects = api_get('/projects')
projects = []
regions = {}
statuses = {}
if isinstance(raw_projects, list):
    for p in raw_projects:
        region = p.get('region', '') or 'unknown'
        regions[region] = regions.get(region, 0) + 1
        status = p.get('status', '') or 'unknown'
        statuses[status] = statuses.get(status, 0) + 1
        projects.append({
            'id': p.get('id', ''),
            'name': p.get('name', ''),
            'organization_id': p.get('organization_id', ''),
            'region': region,
            'status': status,
            'created_at': p.get('created_at', ''),
        })

# Per-project details (first 5)
project_details = []
for p in projects[:5]:
    ref = p['id']
    detail = {'ref': ref, 'name': p['name']}

    # Health
    health = api_get(f'/projects/{ref}/health')
    if isinstance(health, list):
        detail['health'] = {s.get('name', ''): s.get('status', '') for s in health}

    # Secrets
    secrets = api_get(f'/projects/{ref}/secrets')
    if isinstance(secrets, list):
        detail['secret_count'] = len(secrets)
        detail['secret_names'] = [s.get('name', '') for s in secrets]

    # Functions
    functions = api_get(f'/projects/{ref}/functions')
    if isinstance(functions, list):
        detail['functions'] = [{
            'slug': f.get('slug', ''),
            'name': f.get('name', ''),
            'status': f.get('status', ''),
            'version': f.get('version', ''),
        } for f in functions]

    project_details.append(detail)

snapshot = {
    'organizations': {
        'count': len(orgs),
        'items': orgs,
    },
    'projects': {
        'count': len(projects),
        'by_region': regions,
        'by_status': statuses,
        'items': projects,
    },
    'project_details': project_details,
    'token_valid': token_valid,
}
print(json.dumps(snapshot, indent=2))
"
}

# --- SQL via Management API ---

cmd_sql() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase sql <ref> \"<sql>\" [--read-only] [--file <path>]"
        return 1
    fi
    shift

    local sql=""
    local read_only=false
    local file_path=""

    # Parse args
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --read-only|-r) read_only=true; shift ;;
            --file|-f) file_path="${2:-}"; shift 2 ;;
            *) sql="${sql:+$sql }$1"; shift ;;
        esac
    done

    # Read from file if specified
    if [[ -n "$file_path" ]]; then
        if [[ ! -f "$file_path" ]]; then
            echo "Error: File not found: $file_path" >&2
            return 1
        fi
        sql=$(cat "$file_path")
    fi

    if [[ -z "$sql" ]]; then
        echo "Usage: agent-supabase sql <ref> \"<sql>\" [--read-only] [--file <path>]"
        echo "  Either provide SQL inline or use --file <path>"
        return 1
    fi

    local token="${SUPABASE_ACCESS_TOKEN:-}"
    if [[ -z "$token" ]]; then
        echo "Error: SUPABASE_ACCESS_TOKEN not set" >&2
        return 1
    fi

    # Build request body
    local body
    body=$(python3 -c "
import json, sys
print(json.dumps({
    'query': sys.argv[1],
    'read_only': sys.argv[2] == 'true'
}))
" "$sql" "$read_only")

    local result
    result=$(curl -s -X POST "${SUPABASE_API}/projects/${ref}/database/query" \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/json" \
        -d "$body")

    # Format output
    echo "$result" | python3 -c "
import json, sys

raw = sys.stdin.read().strip()
if not raw:
    print('(empty response)')
    sys.exit(0)

try:
    data = json.loads(raw)
except json.JSONDecodeError:
    print(raw)
    sys.exit(0)

# Error response
if isinstance(data, dict) and ('message' in data or 'error' in data):
    msg = data.get('message', data.get('error', ''))
    detail = data.get('detail', data.get('hint', ''))
    print(f'Error: {msg}')
    if detail:
        print(f'Detail: {detail}')
    sys.exit(1)

# Success — pretty print results
if isinstance(data, list):
    if not data:
        print('(no rows returned)')
    else:
        print(json.dumps(data, indent=2, default=str))
else:
    print(json.dumps(data, indent=2, default=str))
" 2>/dev/null || echo "$result"
}

# --- REST API Data Access ---

cmd_rest() {
    local ref="${1:-}"
    local table="${2:-}"
    if [[ -z "$ref" ]] || [[ -z "$table" ]]; then
        echo "Usage: agent-supabase rest <ref> <table> [options]"
        echo ""
        echo "Read:   --select cols  --filter expr  --limit N  --single  --count"
        echo "Write:  --update '{...}' --filter '...'  (PATCH)"
        echo "        --insert '{...}'                  (POST)"
        echo "        --upsert '{...}'                  (POST + merge)"
        echo "        --delete --filter '...'           (DELETE)"
        return 1
    fi
    shift 2

    # Parse options
    local select_cols="*"
    local filters=()
    local limit=20
    local single=false
    local count_only=false
    local update_data=""
    local insert_data=""
    local upsert_data=""
    local do_delete=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --select) select_cols="$2"; shift 2 ;;
            --filter) filters+=("$2"); shift 2 ;;
            --limit)  limit="$2"; shift 2 ;;
            --single) single=true; shift ;;
            --count)  count_only=true; shift ;;
            --update) update_data="$2"; shift 2 ;;
            --insert) insert_data="$2"; shift 2 ;;
            --upsert) upsert_data="$2"; shift 2 ;;
            --delete) do_delete=true; shift ;;
            *) echo "Unknown option: $1"; return 1 ;;
        esac
    done

    # Get service_role key
    local service_key
    service_key=$(get_service_role_key "$ref")
    if [[ -z "$service_key" ]]; then
        echo "Error: Could not retrieve service_role key for project $ref" >&2
        return 1
    fi

    # Determine HTTP method and body
    local method="GET"
    local body=""
    local prefer_headers=()

    if [[ -n "$update_data" ]]; then
        method="PATCH"
        body="$update_data"
        prefer_headers+=("return=representation")
        if [[ ${#filters[@]} -eq 0 ]]; then
            echo "Error: --update requires --filter to avoid updating all rows" >&2
            return 1
        fi
    elif [[ -n "$insert_data" ]]; then
        method="POST"
        body="$insert_data"
        prefer_headers+=("return=representation")
    elif [[ -n "$upsert_data" ]]; then
        method="POST"
        body="$upsert_data"
        prefer_headers+=("return=representation" "resolution=merge-duplicates")
    elif [[ "$do_delete" == true ]]; then
        method="DELETE"
        prefer_headers+=("return=representation")
        if [[ ${#filters[@]} -eq 0 ]]; then
            echo "Error: --delete requires --filter to avoid deleting all rows" >&2
            return 1
        fi
    fi

    # Build URL
    local url="https://${ref}.supabase.co/rest/v1/${table}?select=${select_cols}"
    if [[ "$method" == "GET" ]]; then
        url="${url}&limit=${limit}"
    fi
    for f in "${filters[@]+"${filters[@]}"}"; do
        url="${url}&${f}"
    done

    # Build curl args
    local args=(-s -X "$method" "$url"
        -H "apikey: $service_key"
        -H "Authorization: Bearer $service_key"
        -H "Content-Type: application/json")

    # Add Prefer headers
    if [[ ${#prefer_headers[@]} -gt 0 ]]; then
        local IFS=","
        args+=(-H "Prefer: ${prefer_headers[*]}")
    fi

    if [[ "$single" == true ]]; then
        args+=(-H "Accept: application/vnd.pgrst.object+json")
    fi
    if [[ "$count_only" == true ]]; then
        args+=(-H "Prefer: count=exact" -H "Range: 0-0")
    fi

    # Add body for write operations
    if [[ -n "$body" ]]; then
        args+=(-d "$body")
    fi

    local result
    result=$(curl "${args[@]}")

    if [[ "$count_only" == true ]]; then
        # Extract count from content-range header
        local count_result
        count_result=$(curl "${args[@]}" -D - -o /dev/null 2>/dev/null | grep -i content-range | sed 's/.*\///')
        echo "{\"table\": \"$table\", \"count\": ${count_result:-null}}"
    else
        # Pretty-print JSON
        echo "$result" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    if isinstance(data, dict) and 'message' in data:
        print(f\"Error: {data['message']}\")
        sys.exit(1)
    if isinstance(data, list):
        label = 'Rows' if '$method' == 'GET' else 'Affected'
        print(f'{label}: {len(data)}')
        print(json.dumps(data, indent=2, default=str))
    else:
        print(json.dumps(data, indent=2, default=str))
except json.JSONDecodeError:
    print(sys.stdin.read())
" 2>/dev/null || echo "$result"
    fi
}

# --- Database Bridge (agent-db tandem) ---

cmd_db_connect() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase db-connect <ref>"
        return 1
    fi

    local profile
    profile=$(db_profile_name "$ref")

    # Check if profile already exists
    local existing
    existing=$(run_agent_db profiles 2>/dev/null | python3 -c "
import json, sys
data = json.load(sys.stdin)
for p in data.get('profiles', []):
    if p.get('name') == '$profile':
        print('exists')
        break
" 2>/dev/null)

    if [[ "$existing" == "exists" ]]; then
        echo "Profile '$profile' already exists. Connecting..."
        run_agent_db connect "$profile"
        return $?
    fi

    # Get DB host from Management API
    local project_info
    project_info=$(supabase_request GET "/projects/$ref")
    local db_host
    db_host=$(echo "$project_info" | python3 -c "
import json, sys
d = json.load(sys.stdin)
db = d.get('database', {})
print(db.get('host', ''))
" 2>/dev/null)

    if [[ -z "$db_host" ]]; then
        echo "Error: Could not get database host for project $ref" >&2
        return 1
    fi

    # Get password from env
    local db_password="${SUPABASE_DB_PASSWORD:-}"
    # Also check ref-specific env var
    local ref_upper
    ref_upper=$(echo "$ref" | tr '[:lower:]' '[:upper:]')
    local ref_env="SUPABASE_DB_PASSWORD_${ref_upper}"
    if [[ -n "${!ref_env:-}" ]]; then
        db_password="${!ref_env}"
    fi

    if [[ -z "$db_password" ]]; then
        echo "Error: DB password required. Set SUPABASE_DB_PASSWORD or SUPABASE_DB_PASSWORD_${ref_upper}" >&2
        echo "" >&2
        echo "Find your password in the Supabase dashboard:" >&2
        echo "  Project Settings → Database → Connection string" >&2
        return 1
    fi

    # Create agent-db profile
    echo "Creating agent-db profile '$profile' for $ref..."
    run_agent_db profile add "$profile" \
        --type postgres \
        --host "$db_host" \
        --port 5432 \
        --database postgres \
        --user postgres \
        --password "$db_password"

    local rc=$?
    if [[ $rc -ne 0 ]]; then
        echo "Error: Failed to create agent-db profile" >&2
        return $rc
    fi

    # Connect
    echo "Connecting..."
    run_agent_db connect "$profile"
}

cmd_db_status() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase db-status <ref>"
        return 1
    fi

    local profile
    profile=$(db_profile_name "$ref")

    local existing
    existing=$(run_agent_db profiles 2>/dev/null | python3 -c "
import json, sys
data = json.load(sys.stdin)
for p in data.get('profiles', []):
    if p.get('name') == '$profile':
        print(json.dumps(p, indent=2))
        break
else:
    print('{\"exists\": false}')
" 2>/dev/null)

    echo "$existing"
}

# Ensure db profile is connected, auto-connect if possible
ensure_db_connected() {
    local ref="$1"
    local profile
    profile=$(db_profile_name "$ref")

    # Check current status
    local status
    status=$(run_agent_db status 2>/dev/null | python3 -c "
import json, sys
d = json.load(sys.stdin)
print(d.get('profile', ''))
" 2>/dev/null)

    if [[ "$status" == "$profile" ]]; then
        return 0
    fi

    # Try to connect to existing profile
    local existing
    existing=$(run_agent_db profiles 2>/dev/null | python3 -c "
import json, sys
data = json.load(sys.stdin)
for p in data.get('profiles', []):
    if p.get('name') == '$profile':
        print('exists')
        break
" 2>/dev/null)

    if [[ "$existing" == "exists" ]]; then
        run_agent_db connect "$profile" >/dev/null 2>&1
        return $?
    fi

    echo "Error: No agent-db profile for project $ref" >&2
    echo "Run: agent-supabase db-connect $ref" >&2
    return 1
}

cmd_query() {
    local ref="${1:-}"
    local sql="${2:-}"
    if [[ -z "$ref" ]] || [[ -z "$sql" ]]; then
        echo "Usage: agent-supabase query <ref> \"<sql>\""
        return 1
    fi
    shift 2
    ensure_db_connected "$ref" || return $?
    run_agent_db query "$sql" "$@"
}

cmd_tables() {
    local ref="${1:-}"
    if [[ -z "$ref" ]]; then
        echo "Usage: agent-supabase tables <ref>"
        return 1
    fi
    ensure_db_connected "$ref" || return $?
    run_agent_db snapshot --tables
}

cmd_describe() {
    local ref="${1:-}"
    local table="${2:-}"
    if [[ -z "$ref" ]] || [[ -z "$table" ]]; then
        echo "Usage: agent-supabase describe <ref> <table>"
        return 1
    fi
    ensure_db_connected "$ref" || return $?
    run_agent_db describe "$table"
}

cmd_sample() {
    local ref="${1:-}"
    local table="${2:-}"
    local n="${3:-5}"
    if [[ -z "$ref" ]] || [[ -z "$table" ]]; then
        echo "Usage: agent-supabase sample <ref> <table> [n]"
        return 1
    fi
    ensure_db_connected "$ref" || return $?
    run_agent_db sample "$table" "$n"
}

# --- Main ---

case "${1:-help}" in
    projects|ls|list)
        cmd_projects
        ;;
    show|get)
        shift
        cmd_show "$@"
        ;;
    pause)
        shift
        cmd_pause "$@"
        ;;
    restore)
        shift
        cmd_restore "$@"
        ;;
    health)
        shift
        cmd_health "$@"
        ;;
    api-keys)
        shift
        cmd_api_keys "$@"
        ;;
    secrets)
        shift
        cmd_secrets "$@"
        ;;
    secret-set)
        shift
        cmd_secret_set "$@"
        ;;
    secret-del|secret-delete|secret-rm)
        shift
        cmd_secret_del "$@"
        ;;
    functions|fns)
        shift
        cmd_functions "$@"
        ;;
    function-show|fn-show)
        shift
        cmd_function_show "$@"
        ;;
    domains)
        shift
        cmd_domains "$@"
        ;;
    types)
        shift
        cmd_types "$@"
        ;;
    orgs|organizations)
        cmd_orgs
        ;;
    regions)
        cmd_regions
        ;;
    postgrest)
        shift
        cmd_postgrest "$@"
        ;;
    snapshot|snap)
        cmd_snapshot
        ;;
    # --- SQL via Management API ---
    sql|run-sql|migrate)
        shift
        cmd_sql "$@"
        ;;
    # --- REST API data access ---
    rest)
        shift
        cmd_rest "$@"
        ;;
    # --- Database bridge (agent-db tandem) ---
    db-connect|db-setup)
        shift
        cmd_db_connect "$@"
        ;;
    db-status)
        shift
        cmd_db_status "$@"
        ;;
    query|sql)
        shift
        cmd_query "$@"
        ;;
    tables)
        shift
        cmd_tables "$@"
        ;;
    describe|desc)
        shift
        cmd_describe "$@"
        ;;
    sample)
        shift
        cmd_sample "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-supabase --help"
        exit 1
        ;;
esac
