#!/usr/bin/env bash
# agent-jupyter - Jupyter notebook control

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-jupyter - Jupyter notebook control

Commands:
  start [dir]                Start Jupyter server
  stop                       Stop Jupyter server
  list                       List running servers
  open <notebook>            Open notebook in browser
  run <notebook>             Execute notebook
  convert <notebook> <fmt>   Convert notebook (html, pdf, py, md)
  create <name>              Create new notebook
  snapshot [notebook]        Jupyter state as JSON (servers, kernels, notebook cells)

Options:
  --port <port>              Server port (default: 8888)
  --no-browser               Don't open browser

Formats for convert:
  html, pdf, latex, markdown, script (py), slides

Examples:
  agent-jupyter start
  agent-jupyter run analysis.ipynb
  agent-jupyter convert report.ipynb html
  agent-jupyter create "New Analysis"
EOF
}

cmd_start() {
    local dir="${1:-.}"
    local port=8888
    local no_browser=""

    shift || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --port|-p) port="$2"; shift 2 ;;
            --no-browser) no_browser="--no-browser"; shift ;;
            *) shift ;;
        esac
    done

    if command -v jupyter &> /dev/null; then
        jupyter notebook --notebook-dir="$dir" --port="$port" $no_browser &
        echo "Jupyter started on port $port"
        echo "URL: http://localhost:$port"
    elif command -v jupyter-notebook &> /dev/null; then
        jupyter-notebook --notebook-dir="$dir" --port="$port" $no_browser &
        echo "Jupyter started on port $port"
    else
        echo "Error: jupyter not found"
        echo "Install with: pip install jupyter"
        return 1
    fi
}

cmd_stop() {
    if command -v jupyter &> /dev/null; then
        jupyter notebook stop
    else
        # Kill by process
        pkill -f "jupyter-notebook" || pkill -f "jupyter notebook" || echo "No Jupyter server running"
    fi
    echo "Jupyter server stopped"
}

cmd_list() {
    if command -v jupyter &> /dev/null; then
        jupyter notebook list
    else
        echo "Error: jupyter not found"
        return 1
    fi
}

cmd_open() {
    local notebook="${1:-}"

    if [[ -z "$notebook" ]]; then
        echo "Error: Notebook path required"
        return 1
    fi

    if [[ ! -f "$notebook" ]]; then
        echo "Error: Notebook not found: $notebook"
        return 1
    fi

    # Get running server URL
    local server_url
    if command -v jupyter &> /dev/null; then
        server_url=$(jupyter notebook list 2>/dev/null | grep "http" | head -1 | awk '{print $1}')
    fi

    if [[ -n "$server_url" ]]; then
        local notebook_name=$(basename "$notebook")
        open "${server_url}notebooks/${notebook_name}"
    else
        # Start server and open
        jupyter notebook "$notebook" &
    fi
}

cmd_run() {
    local notebook="${1:-}"
    local output=""
    local inplace=""

    shift || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -o|--output) output="$2"; shift 2 ;;
            --inplace|-i) inplace="--inplace"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$notebook" ]]; then
        echo "Error: Notebook path required"
        return 1
    fi

    if ! command -v jupyter &> /dev/null; then
        echo "Error: jupyter not found"
        return 1
    fi

    local args=(nbconvert --to notebook --execute)
    [[ -n "$inplace" ]] && args+=(--inplace)
    [[ -n "$output" ]] && args+=(--output "$output")

    jupyter "${args[@]}" "$notebook"
    echo "Executed: $notebook"
}

cmd_convert() {
    local notebook="${1:-}"
    local format="${2:-html}"
    local output=""

    shift 2 || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -o|--output) output="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    if [[ -z "$notebook" ]]; then
        echo "Error: Notebook path required"
        return 1
    fi

    if ! command -v jupyter &> /dev/null; then
        echo "Error: jupyter not found"
        return 1
    fi

    # Map format aliases
    case "$format" in
        py|python) format="script" ;;
        md) format="markdown" ;;
    esac

    local args=(nbconvert --to "$format")
    [[ -n "$output" ]] && args+=(--output "$output")

    jupyter "${args[@]}" "$notebook"
    echo "Converted to $format"
}

cmd_create() {
    local name="${1:-Untitled}"

    # Ensure .ipynb extension
    [[ ! "$name" =~ \.ipynb$ ]] && name="${name}.ipynb"

    # Create minimal notebook
    cat > "$name" << 'EOF'
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.10.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
EOF

    echo "Created: $name"
}

cmd_kernels() {
    if command -v jupyter &> /dev/null; then
        jupyter kernelspec list
    else
        echo "Error: jupyter not found"
        return 1
    fi
}

cmd_snapshot() {
    local notebook="${1:-}"

    python3 -c "
import subprocess, json, os, sys

def run(cmd):
    r = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=10)
    return r.stdout.strip()

snapshot = {}

# Running servers
servers = []
try:
    raw = run('jupyter notebook list 2>/dev/null')
    for line in raw.split('\n'):
        line = line.strip()
        if line.startswith('http'):
            parts = line.split(' :: ')
            url = parts[0].strip() if parts else line
            directory = parts[1].strip() if len(parts) > 1 else ''
            servers.append({'url': url, 'directory': directory})
except:
    pass

snapshot['servers'] = {'count': len(servers), 'items': servers}

# Available kernels
kernels = []
try:
    raw = run('jupyter kernelspec list --json 2>/dev/null')
    if raw:
        kdata = json.loads(raw)
        for name, info in kdata.get('kernelspecs', {}).items():
            kernels.append({
                'name': name,
                'display_name': info.get('spec', {}).get('display_name', name),
                'language': info.get('spec', {}).get('language', ''),
            })
except:
    pass

snapshot['kernels'] = {'count': len(kernels), 'items': kernels}

# Notebook info (if path provided)
notebook_path = '$notebook'
if notebook_path and os.path.exists(notebook_path):
    try:
        with open(notebook_path) as f:
            nb = json.load(f)
        cells = nb.get('cells', [])
        cell_summary = []
        for i, cell in enumerate(cells):
            source = ''.join(cell.get('source', []))
            outputs = cell.get('outputs', [])
            has_error = any(o.get('output_type') == 'error' for o in outputs)
            cell_summary.append({
                'index': i,
                'type': cell.get('cell_type', ''),
                'source_preview': source[:100] + ('...' if len(source) > 100 else ''),
                'execution_count': cell.get('execution_count'),
                'has_output': len(outputs) > 0,
                'has_error': has_error,
            })

        kernel = nb.get('metadata', {}).get('kernelspec', {})
        snapshot['notebook'] = {
            'path': notebook_path,
            'kernel': kernel.get('display_name', 'unknown'),
            'language': kernel.get('language', ''),
            'cell_count': len(cells),
            'code_cells': sum(1 for c in cells if c.get('cell_type') == 'code'),
            'markdown_cells': sum(1 for c in cells if c.get('cell_type') == 'markdown'),
            'cells': cell_summary,
        }
    except Exception as e:
        snapshot['notebook'] = {'error': str(e)}

# Find notebooks in current directory
local_notebooks = []
for f in sorted(os.listdir('.')):
    if f.endswith('.ipynb') and not f.startswith('.'):
        size = os.path.getsize(f)
        local_notebooks.append({'name': f, 'size': size})

snapshot['local_notebooks'] = {'count': len(local_notebooks), 'items': local_notebooks[:20]}

# Jupyter installed?
snapshot['jupyter_available'] = bool(run('which jupyter 2>/dev/null'))

print(json.dumps(snapshot, indent=2))
"
}

# Main
case "${1:-help}" in
    start|serve)
        shift || true
        cmd_start "$@"
        ;;
    stop|shutdown)
        cmd_stop
        ;;
    list|ls|servers)
        cmd_list
        ;;
    open|view)
        shift
        cmd_open "$@"
        ;;
    run|execute|exec)
        shift
        cmd_run "$@"
        ;;
    convert|export)
        shift
        cmd_convert "$@"
        ;;
    create|new)
        shift || true
        cmd_create "$@"
        ;;
    kernels)
        cmd_kernels
        ;;
    snapshot|snap)
        shift || true
        cmd_snapshot "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-jupyter help"
        exit 1
        ;;
esac
