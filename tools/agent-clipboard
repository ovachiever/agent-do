#!/usr/bin/env bash
# agent-clipboard - Clipboard management tool

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-clipboard - Clipboard management

Commands:
  copy <text>      Copy text to clipboard
  paste            Print clipboard contents
  clear            Clear clipboard
  file <path>      Copy file contents to clipboard
  snapshot          Clipboard state as JSON (content preview, size, type)

Examples:
  agent-clipboard copy "Hello, World!"
  agent-clipboard paste
  agent-clipboard file ~/.ssh/id_rsa.pub
EOF
}

# Detect clipboard command
get_clipboard_cmd() {
    if [[ "$(uname)" == "Darwin" ]]; then
        echo "pbcopy:pbpaste"
    elif command -v xclip &> /dev/null; then
        echo "xclip -selection clipboard:xclip -selection clipboard -o"
    elif command -v xsel &> /dev/null; then
        echo "xsel --clipboard --input:xsel --clipboard --output"
    elif command -v wl-copy &> /dev/null; then
        echo "wl-copy:wl-paste"
    else
        echo ""
    fi
}

cmd_copy() {
    local text="$*"
    if [[ -z "$text" ]]; then
        echo "Usage: agent-clipboard copy <text>"
        return 1
    fi

    local cmds
    cmds=$(get_clipboard_cmd)
    if [[ -z "$cmds" ]]; then
        echo "Error: No clipboard command found (install xclip, xsel, or wl-clipboard)"
        return 1
    fi

    local copy_cmd="${cmds%%:*}"
    echo -n "$text" | $copy_cmd
    echo "Copied to clipboard: ${text:0:50}$([ ${#text} -gt 50 ] && echo '...')"
}

cmd_paste() {
    local cmds
    cmds=$(get_clipboard_cmd)
    if [[ -z "$cmds" ]]; then
        echo "Error: No clipboard command found"
        return 1
    fi

    local paste_cmd="${cmds##*:}"
    $paste_cmd
}

cmd_clear() {
    local cmds
    cmds=$(get_clipboard_cmd)
    if [[ -z "$cmds" ]]; then
        echo "Error: No clipboard command found"
        return 1
    fi

    local copy_cmd="${cmds%%:*}"
    echo -n "" | $copy_cmd
    echo "Clipboard cleared"
}

cmd_file() {
    local path="${1:-}"
    if [[ -z "$path" ]]; then
        echo "Usage: agent-clipboard file <path>"
        return 1
    fi

    if [[ ! -f "$path" ]]; then
        echo "Error: File not found: $path"
        return 1
    fi

    local cmds
    cmds=$(get_clipboard_cmd)
    if [[ -z "$cmds" ]]; then
        echo "Error: No clipboard command found"
        return 1
    fi

    local copy_cmd="${cmds%%:*}"
    cat "$path" | $copy_cmd
    local bytes
    bytes=$(wc -c < "$path" | tr -d ' ')
    echo "Copied $bytes bytes from $path to clipboard"
}

cmd_snapshot() {
    local cmds
    cmds=$(get_clipboard_cmd)
    if [[ -z "$cmds" ]]; then
        echo '{"error": "No clipboard command found"}'
        return 1
    fi

    local paste_cmd="${cmds##*:}"
    local content
    content=$($paste_cmd 2>/dev/null) || content=""

    python3 -c "
import json, sys

content = sys.stdin.read()
length = len(content)

# Detect content type
content_type = 'text'
trimmed = content.strip()
if not trimmed:
    content_type = 'empty'
elif trimmed.startswith('{') or trimmed.startswith('['):
    try:
        json.loads(trimmed)
        content_type = 'json'
    except:
        pass
elif trimmed.startswith('<') and ('>' in trimmed):
    content_type = 'html/xml'
elif trimmed.startswith('http://') or trimmed.startswith('https://'):
    content_type = 'url'
elif '/' in trimmed and '\n' not in trimmed and length < 500:
    content_type = 'path'

# Preview (first 200 chars)
preview = content[:200]
if length > 200:
    preview += '...'

lines = content.count('\n') + (1 if content else 0)

snapshot = {
    'has_content': length > 0,
    'length': length,
    'lines': lines,
    'type': content_type,
    'preview': preview,
}
print(json.dumps(snapshot, indent=2))
" <<< "$content"
}

# Main
case "${1:-help}" in
    copy|cp)
        shift
        cmd_copy "$@"
        ;;
    paste|get)
        cmd_paste
        ;;
    clear)
        cmd_clear
        ;;
    file)
        shift
        cmd_file "$@"
        ;;
    snapshot|snap)
        cmd_snapshot
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-clipboard help"
        exit 1
        ;;
esac
