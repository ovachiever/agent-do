#!/usr/bin/env bash
# agent-api - HTTP API testing tool

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-api - HTTP API testing

Commands:
  get <url>                    GET request
  post <url> [data]            POST request
  put <url> [data]             PUT request
  delete <url>                 DELETE request
  head <url>                   HEAD request
  snapshot                     API state: environment, base URL, recent history
  history                      Show last 20 requests with status codes
  env [name] [url]             Set/show base URL environment (stored in ~/.agent-do/api-envs.json)

Options:
  -H, --header "Key: Value"    Add header
  -d, --data '{"key":"val"}'   Request body (JSON)
  -f, --file <path>            Read body from file
  -o, --output <path>          Save response to file
  -v, --verbose                Show headers
  -q, --quiet                  Only output response body
  --json                       Set Content-Type: application/json

Examples:
  agent-api get https://api.github.com/users/octocat
  agent-api post http://localhost:3000/api/users -d '{"name":"test"}'
  agent-api get /api/users --header "Authorization: Bearer TOKEN"
EOF
}

# Default base URL (can be set via AGENT_API_BASE)
BASE_URL="${AGENT_API_BASE:-}"

build_url() {
    local url="$1"
    if [[ "$url" =~ ^https?:// ]]; then
        echo "$url"
    elif [[ -n "$BASE_URL" ]]; then
        echo "${BASE_URL%/}/${url#/}"
    else
        echo "$url"
    fi
}

do_request() {
    local method="$1"
    shift

    local url=""
    local headers=()
    local data=""
    local data_file=""
    local output=""
    local verbose=""
    local quiet=""
    local json_content=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -H|--header)
                headers+=(-H "$2")
                shift 2
                ;;
            -d|--data)
                data="$2"
                shift 2
                ;;
            -f|--file)
                data_file="$2"
                shift 2
                ;;
            -o|--output)
                output="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="-v"
                shift
                ;;
            -q|--quiet)
                quiet="-s"
                shift
                ;;
            --json)
                json_content=1
                shift
                ;;
            -*)
                echo "Unknown option: $1"
                return 1
                ;;
            *)
                if [[ -z "$url" ]]; then
                    url="$1"
                else
                    # Treat as data if no -d specified
                    [[ -z "$data" ]] && data="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$url" ]]; then
        echo "Error: URL required"
        return 1
    fi

    url=$(build_url "$url")

    local curl_args=(-X "$method")

    # Add JSON content type if specified or if data looks like JSON
    if [[ -n "$json_content" ]] || [[ "$data" =~ ^\{ ]]; then
        curl_args+=(-H "Content-Type: application/json")
    fi

    # Add custom headers
    curl_args+=("${headers[@]}")

    # Add data
    if [[ -n "$data" ]]; then
        curl_args+=(-d "$data")
    elif [[ -n "$data_file" ]]; then
        curl_args+=(-d "@$data_file")
    fi

    # Verbose/quiet
    [[ -n "$verbose" ]] && curl_args+=(-v)
    [[ -n "$quiet" ]] && curl_args+=(-s)
    [[ -z "$verbose" && -z "$quiet" ]] && curl_args+=(-s -S)

    # Output file
    if [[ -n "$output" ]]; then
        curl_args+=(-o "$output")
    fi

    # Show response with status code
    if [[ -z "$quiet" && -z "$output" ]]; then
        curl_args+=(-w '\n\n[Status: %{http_code}, Time: %{time_total}s, Size: %{size_download} bytes]\n')
    fi

    curl "${curl_args[@]}" "$url"

    # Log to history
    python3 -c "
import json, os, time
history_file = os.path.expanduser('~/.agent-do/api-history.json')
os.makedirs(os.path.dirname(history_file), exist_ok=True)
history = []
if os.path.exists(history_file):
    try:
        with open(history_file) as f:
            history = json.load(f)
    except: pass
history.append({'method': '$method', 'url': '$url', 'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')})
# Keep last 100
history = history[-100:]
with open(history_file, 'w') as f:
    json.dump(history, f)
" 2>/dev/null &
}

cmd_snapshot() {
    python3 -c "
import json, os

env_file = os.path.expanduser('~/.agent-do/api-envs.json')
history_file = os.path.expanduser('~/.agent-do/api-history.json')

# Load envs
envs = {}
if os.path.exists(env_file):
    with open(env_file) as f:
        envs = json.load(f)

# Load history
history = []
if os.path.exists(history_file):
    with open(history_file) as f:
        history = json.load(f)

base_url = os.environ.get('AGENT_API_BASE', '')

snapshot = {
    'base_url': base_url or '(not set)',
    'environments': envs,
    'recent_requests': history[-10:],
    'total_requests': len(history),
}
print(json.dumps(snapshot, indent=2))
"
}

cmd_history() {
    python3 -c "
import json, os

history_file = os.path.expanduser('~/.agent-do/api-history.json')
history = []
if os.path.exists(history_file):
    with open(history_file) as f:
        history = json.load(f)

if not history:
    print('No request history')
else:
    for h in history[-20:]:
        status = h.get('status', '?')
        method = h.get('method', '?')
        url = h.get('url', '?')
        time_str = h.get('time', '?')
        print(f'  {status}  {method:6s}  {url}  ({time_str}s)')
"
}

cmd_env() {
    local name="${1:-}"
    local url="${2:-}"

    python3 -c "
import json, os, sys

env_file = os.path.expanduser('~/.agent-do/api-envs.json')
os.makedirs(os.path.dirname(env_file), exist_ok=True)

envs = {}
if os.path.exists(env_file):
    with open(env_file) as f:
        envs = json.load(f)

name = '$name'
url = '$url'

if not name:
    # Show all envs
    if not envs:
        print('No environments configured')
        print('Usage: agent-api env <name> <base_url>')
    else:
        for n, u in envs.items():
            print(f'  {n}: {u}')
elif url:
    # Set env
    envs[name] = url
    with open(env_file, 'w') as f:
        json.dump(envs, f, indent=2)
    print(f'Set {name} = {url}')
    print(f'Use: AGENT_API_BASE=\"{url}\" agent-api get /endpoint')
else:
    # Show specific env
    if name in envs:
        print(envs[name])
    else:
        print(f'Environment \"{name}\" not found')
        sys.exit(1)
"
}

# Main
case "${1:-help}" in
    get|GET)
        shift
        do_request GET "$@"
        ;;
    post|POST)
        shift
        do_request POST "$@"
        ;;
    put|PUT)
        shift
        do_request PUT "$@"
        ;;
    patch|PATCH)
        shift
        do_request PATCH "$@"
        ;;
    delete|DELETE)
        shift
        do_request DELETE "$@"
        ;;
    head|HEAD)
        shift
        do_request HEAD -v "$@"
        ;;
    snapshot|snap)
        cmd_snapshot
        ;;
    history|hist)
        cmd_history
        ;;
    env|environment)
        shift
        cmd_env "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        # If it looks like a URL, default to GET
        if [[ "$1" =~ ^https?:// ]] || [[ "$1" =~ ^/ ]]; then
            do_request GET "$@"
        else
            echo "Unknown command: $1"
            echo "Try: agent-api help"
            exit 1
        fi
        ;;
esac
