#!/usr/bin/env bash
# agent-gui - Desktop GUI automation via accessibility APIs

set -euo pipefail

show_help() {
    cat << 'EOF'
agent-gui - Desktop GUI automation (macOS)

Commands:
  list                       List running applications
  tree <app>                 Get UI element tree
  click <app> <element>      Click element by title/role
  type <text>                Type text into focused element
  focus <app>                Focus/activate application
  menu <app> <menu> <item>   Click menu item
  window <app> [action]      Window actions (minimize, maximize, close)
  screenshot <app> [path]    Screenshot specific app window

Options:
  --title <text>             Match element by title
  --role <role>              Match by role (button, textfield, etc.)
  --index <n>                Match nth element

Examples:
  agent-gui list
  agent-gui tree Finder
  agent-gui click Safari --title "Downloads"
  agent-gui type "Hello World"
  agent-gui menu Finder File "New Window"
  agent-gui focus "Visual Studio Code"
EOF
}

# Check for macOS
check_macos() {
    if [[ "$(uname)" != "Darwin" ]]; then
        echo "Error: agent-gui requires macOS"
        exit 1
    fi
}

cmd_list() {
    check_macos
    osascript -e 'tell application "System Events" to get name of every process whose background only is false'
}

cmd_tree() {
    check_macos
    local app="${1:-}"

    if [[ -z "$app" ]]; then
        echo "Error: Application name required"
        return 1
    fi

    # Get UI hierarchy using AppleScript
    osascript << EOF
tell application "System Events"
    tell process "$app"
        set output to ""
        repeat with w in windows
            set output to output & "Window: " & (name of w) & "\n"
            try
                repeat with e in UI elements of w
                    set output to output & "  " & (role of e) & ": " & (name of e) & "\n"
                    try
                        repeat with sub in UI elements of e
                            set output to output & "    " & (role of sub) & ": " & (name of sub) & "\n"
                        end repeat
                    end try
                end repeat
            end try
        end repeat
        return output
    end tell
end tell
EOF
}

cmd_click() {
    check_macos
    local app=""
    local title=""
    local role=""
    local index=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --title) title="$2"; shift 2 ;;
            --role) role="$2"; shift 2 ;;
            --index) index="$2"; shift 2 ;;
            *) [[ -z "$app" ]] && app="$1"; shift ;;
        esac
    done

    if [[ -z "$app" ]]; then
        echo "Error: Application name required"
        return 1
    fi

    local script=""
    if [[ -n "$title" ]] && [[ -n "$role" ]]; then
        script="click ${role} \"$title\" of window 1"
    elif [[ -n "$title" ]]; then
        script="click (first UI element whose name is \"$title\") of window 1"
    elif [[ -n "$role" ]]; then
        script="click first ${role} of window 1"
    else
        echo "Error: --title or --role required"
        return 1
    fi

    osascript << EOF
tell application "$app" to activate
delay 0.3
tell application "System Events"
    tell process "$app"
        $script
    end tell
end tell
EOF
    echo "Clicked element in $app"
}

cmd_type() {
    check_macos
    local text="$*"

    if [[ -z "$text" ]]; then
        echo "Error: Text required"
        return 1
    fi

    osascript -e "tell application \"System Events\" to keystroke \"$text\""
    echo "Typed: $text"
}

cmd_focus() {
    check_macos
    local app="$1"

    if [[ -z "$app" ]]; then
        echo "Error: Application name required"
        return 1
    fi

    osascript -e "tell application \"$app\" to activate"
    echo "Focused: $app"
}

cmd_menu() {
    check_macos
    local app="${1:-}"
    local menu="${2:-}"
    local item="${3:-}"

    if [[ -z "$app" ]] || [[ -z "$menu" ]] || [[ -z "$item" ]]; then
        echo "Error: App, menu, and item required"
        echo "Usage: agent-gui menu <app> <menu> <item>"
        return 1
    fi

    osascript << EOF
tell application "$app" to activate
delay 0.2
tell application "System Events"
    tell process "$app"
        click menu item "$item" of menu "$menu" of menu bar 1
    end tell
end tell
EOF
    echo "Clicked $menu > $item in $app"
}

cmd_window() {
    check_macos
    local app="${1:-}"
    local action="${2:-list}"

    if [[ -z "$app" ]]; then
        echo "Error: Application name required"
        return 1
    fi

    case "$action" in
        list)
            osascript -e "tell application \"$app\" to get name of every window"
            ;;
        minimize|min)
            osascript -e "tell application \"$app\" to set miniaturized of front window to true"
            echo "Minimized $app window"
            ;;
        maximize|max|zoom)
            osascript << EOF
tell application "$app" to activate
tell application "System Events"
    tell process "$app"
        click button 2 of window 1
    end tell
end tell
EOF
            echo "Maximized $app window"
            ;;
        close)
            osascript -e "tell application \"$app\" to close front window"
            echo "Closed $app window"
            ;;
        *)
            echo "Unknown action: $action"
            echo "Actions: list, minimize, maximize, close"
            return 1
            ;;
    esac
}

cmd_screenshot() {
    check_macos
    local app="${1:-}"
    local output="${2:-/tmp/app-screenshot.png}"

    if [[ -z "$app" ]]; then
        echo "Error: Application name required"
        return 1
    fi

    # Get window ID and screenshot
    local window_id
    window_id=$(osascript -e "tell application \"$app\" to id of front window" 2>/dev/null || echo "")

    if [[ -n "$window_id" ]]; then
        screencapture -l "$window_id" "$output"
    else
        # Fallback: activate and screenshot
        osascript -e "tell application \"$app\" to activate"
        sleep 0.5
        screencapture -w "$output"
    fi

    echo "Screenshot saved to $output"
}

# Main
case "${1:-help}" in
    list|ls|apps)
        cmd_list
        ;;
    tree|hierarchy|ui)
        shift
        cmd_tree "$@"
        ;;
    click)
        shift
        cmd_click "$@"
        ;;
    type|text|input)
        shift
        cmd_type "$@"
        ;;
    focus|activate)
        shift
        cmd_focus "$@"
        ;;
    menu)
        shift
        cmd_menu "$@"
        ;;
    window|win)
        shift
        cmd_window "$@"
        ;;
    screenshot|snap)
        shift
        cmd_screenshot "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Try: agent-gui help"
        exit 1
        ;;
esac
